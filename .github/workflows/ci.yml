name: C++ CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake g++ make libgtest-dev nlohmann-json3-dev \
                            libpoppler-cpp-dev libpugixml-dev valgrind lcov

    - name: Build GTest
      run: |
        cd /usr/src/gtest
        sudo cmake -S . -B build
        sudo cmake --build build
        sudo cmake --install build

    - name: Configure & Build
      run: |
        # Force Debug mode to enable coverage flags from CMakeLists.txt
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug -DSAVE_GENERATED_FILES=0
        cmake --build build -- -j$(nproc)

    - name: Run Tests & Gather Coverage
      run: |
        # 1. Reset any existing counters
        lcov --directory . --zerocounters
        
        # 2. Execute tests
        cd build
        ./test_report_loader
        ./test_xml_generator
        ./test_application_service
        cd ..
        
        # 3. Capture coverage data
        lcov --directory . --capture --output-file coverage.info
        
        # 4. Filter only for our specific logic files
        lcov --extract coverage.info "*/src/app/application_service.cpp" \
                                     "*/src/backend/report_loader.cpp" \
                                     "*/src/backend/xml_generator.cpp" \
                                     --output-file coverage.info.filtered
        
        # 5. Generate HTML Report
        mkdir -p tests/coverage_report
        genhtml coverage.info.filtered --output-directory tests/coverage_report

    - name: Valgrind Memory Check
      run: |
        set -e
        for t in test_report_loader test_xml_generator test_application_service; do
          valgrind --leak-check=full --error-exitcode=1 "./build/$t"
        done

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: code-coverage-report
        path: tests/coverage_report/
        retention-days: 7